name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: read

jobs:
  publish:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    runs-on: ubuntu-latest
    permissions:
      id-token: write # for crates.io trusted publishing (optional)
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Verify tag matches Cargo.toml version
        shell: bash
        run: |
          TAG="${{ github.event.workflow_run.head_branch }}"
          TAG="${TAG#v}"
          CARGO_VER="$(cargo metadata --format-version=1 --no-deps | jq -r '.packages[0].version')"
          echo "tag=$TAG cargo=$CARGO_VER"
          test "$TAG" = "$CARGO_VER"

      # --- crates.io publish ---
      - uses: dtolnay/rust-toolchain@stable

      # (A) token-based (simpler): store CRATES_IO_TOKEN secret
      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish --locked

      # --- PyPI publish ---
      - uses: actions/download-artifact@v4

      - name: Upload to PyPI
        uses: PyO3/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --non-interactive --skip-existing wheels-*/*
